// GPU数学函数测试示例
// 展示如何在NVIDIA和AMD GPU上使用各种数学函数

// ============================
// NVIDIA GPU 测试
// ============================

use ::nvgpu as gpu;

@kernel
@target("nvptx")
func nvidiaMathKernel(tensor: gpu::Tensor<f32, 1>) {
    var idx = 0i64;
    
    // 测试基础三角函数
    var angle = 3.1415f32 / 4.0f32;  // π/4
    tensor[idx] = angle.Sin();        // sin(π/4) ≈ 0.7071
    idx = idx + 1;
    
    tensor[idx] = angle.Cos();        // cos(π/4) ≈ 0.7071
    idx = idx + 1;
    
    tensor[idx] = angle.Tan();        // tan(π/4) = 1.0
    idx = idx + 1;
    
    // 测试反三角函数
    var value = 0.5f32;
    tensor[idx] = value.Asin();       // asin(0.5) ≈ 0.5236
    idx = idx + 1;
    
    tensor[idx] = value.Acos();       // acos(0.5) ≈ 1.0472
    idx = idx + 1;
    
    tensor[idx] = value.Atan();       // atan(0.5) ≈ 0.4636
    idx = idx + 1;
    
    // 测试基础数学函数
    var num = 4.0f32;
    tensor[idx] = num.Sqrt();         // sqrt(4) = 2.0
    idx = idx + 1;
    
    tensor[idx] = num.Pow(2.0f32);    // 4^2 = 16.0
    idx = idx + 1;
    
    tensor[idx] = num.Abs();          // abs(4) = 4.0
    idx = idx + 1;
}

@test
func TestNvidiaMath() {
    "=== NVIDIA GPU数学函数测试 ===".PrintLine();
    
    var shape = [9i64];  // 9个测试结果
    var gpu_tensor = gpu::Tensor<f32, 1>::Create(shape);
    
    nvidiaMathKernel<|[1,1,1], [1,1,1]|>(gpu_tensor);
    gpu::Synchronize();
    
    var host_tensor = gpu_tensor.ToHost();
    
    // 验证结果
    test::Assert((host_tensor[0] - 0.7071f32).Abs() < 0.001f32);  // sin(π/4)
    test::Assert((host_tensor[1] - 0.7071f32).Abs() < 0.001f32);  // cos(π/4)
    test::Assert((host_tensor[2] - 1.0f32).Abs() < 0.001f32);     // tan(π/4)
    test::Assert((host_tensor[3] - 0.5236f32).Abs() < 0.001f32);  // asin(0.5)
    test::Assert((host_tensor[4] - 1.0472f32).Abs() < 0.001f32);  // acos(0.5)
    test::Assert((host_tensor[5] - 0.4636f32).Abs() < 0.001f32);  // atan(0.5)
    test::Assert((host_tensor[6] - 2.0f32).Abs() < 0.001f32);     // sqrt(4)
    test::Assert((host_tensor[7] - 16.0f32).Abs() < 0.001f32);    // 4^2
    test::Assert((host_tensor[8] - 4.0f32).Abs() < 0.001f32);     // abs(4)
    
    "NVIDIA GPU测试通过！".PrintLine();
}

// ============================
// AMD GPU 测试 (可选)
// ============================

// 注意：这个测试需要AMD GPU和ROCm工具链
// 如果没有AMD GPU，可以注释掉这部分代码

/*
use ::amdgpu as gpu;

@kernel
@target("amdgpu")
func amdMathKernel(tensor: gpu::Tensor<f32, 1>) {
    var idx = 0i64;
    
    // 测试基础三角函数
    var angle = 3.1415f32 / 4.0f32;  // π/4
    tensor[idx] = angle.Sin();        // sin(π/4) ≈ 0.7071
    idx = idx + 1;
    
    tensor[idx] = angle.Cos();        // cos(π/4) ≈ 0.7071
    idx = idx + 1;
    
    tensor[idx] = angle.Tan();        // tan(π/4) = 1.0
    idx = idx + 1;
    
    // 测试反三角函数
    var value = 0.5f32;
    tensor[idx] = value.Asin();       // asin(0.5) ≈ 0.5236
    idx = idx + 1;
    
    tensor[idx] = value.Acos();       // acos(0.5) ≈ 1.0472
    idx = idx + 1;
    
    tensor[idx] = value.Atan();       // atan(0.5) ≈ 0.4636
    idx = idx + 1;
    
    // 测试基础数学函数
    var num = 4.0f32;
    tensor[idx] = num.Sqrt();         // sqrt(4) = 2.0
    idx = idx + 1;
    
    tensor[idx] = num.Pow(2.0f32);    // 4^2 = 16.0
    idx = idx + 1;
    
    tensor[idx] = num.Abs();          // abs(4) = 4.0
    idx = idx + 1;
}

@test
func TestAmdMath() {
    "=== AMD GPU数学函数测试 ===".PrintLine();
    
    var shape = [9i64];  // 9个测试结果
    var gpu_tensor = gpu::Tensor<f32, 1>::Create(shape);
    
    amdMathKernel<|[1,1,1], [1,1,1]|>(gpu_tensor);
    gpu::Synchronize();
    
    var host_tensor = gpu_tensor.ToHost();
    
    // 验证结果
    test::Assert((host_tensor[0] - 0.7071f32).Abs() < 0.001f32);  // sin(π/4)
    test::Assert((host_tensor[1] - 0.7071f32).Abs() < 0.001f32);  // cos(π/4)
    test::Assert((host_tensor[2] - 1.0f32).Abs() < 0.001f32);     // tan(π/4)
    test::Assert((host_tensor[3] - 0.5236f32).Abs() < 0.001f32);  // asin(0.5)
    test::Assert((host_tensor[4] - 1.0472f32).Abs() < 0.001f32);  // acos(0.5)
    test::Assert((host_tensor[5] - 0.4636f32).Abs() < 0.001f32);  // atan(0.5)
    test::Assert((host_tensor[6] - 2.0f32).Abs() < 0.001f32);     // sqrt(4)
    test::Assert((host_tensor[7] - 16.0f32).Abs() < 0.001f32);    // 4^2
    test::Assert((host_tensor[8] - 4.0f32).Abs() < 0.001f32);     // abs(4)
    
    "AMD GPU测试通过！".PrintLine();
}
*/

// ============================
// 主函数
// ============================

func Main() {
    "开始GPU数学函数测试...".PrintLine();
    
    // 运行NVIDIA GPU测试
    TestNvidiaMath();
    
    // AMD GPU测试已注释，因为没有AMD GPU环境
    // TestAmdMath();
    
    "所有测试完成！".PrintLine();
}
