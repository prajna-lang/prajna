# 序列化与测试（给初学者）

本篇介绍“把值变成可打印字符串”的 `Serializable` 接口、内置可序列化类型的打印能力、如何给自定义类型启用打印，以及用 `@test` 编写最小化测试。

你将学到：
- `Serializable` 接口与 `ToString()` 约定
- 内置类型（整数/浮点/布尔/字符/数组/张量等）的打印规则
- 通过模板启用 `Print/PrintLine`
- 自定义类型的 ToString 实现
- `serialize::ToBytes/FromBytes` 说明（入门）
- `@test` 的用法与断言

## 1. Serializable 接口与 ToString

接口很简单：
```prajna
interface Serializable{
    func ToString()->String;
}
```
任何实现了 `ToString()` 的类型都可视为可序列化，并可用于打印。

## 2. 内置可序列化类型（节选）

系统已为以下类型提供了 `ToString()`（并配套 `Print/PrintLine`）：
- 字符 `char`：单字符
- 布尔 `bool`：`true/false`
- 整数类 `Int<Bits>/Uint<Bits>`：十进制输出（带符号或无符号）
- 浮点 `Float<Bits>`：小数/科学计数法打印
- 定长数组 `Array<Type, Dim>`：形如 `[a,b,c,...]`
- 张量 `Tensor<Type, Dim>`：嵌套 `[...]` 的层级打印（见张量教程）

你可以直接：
```prajna
(123i64).PrintLine();
(3.14f32).PrintLine();
(true).PrintLine();
```

## 3. 通过模板启用 Print/PrintLine

系统模板会为支持 `ToString()` 的类型注入 `Print/PrintLine` 方法：
```prajna
template EnablePrintable <T> {
    implement T {
        func Print()     { this.ToString().Print(); }
        func PrintLine() { this.ToString().PrintLine(); }
    }
}
```
整数/无符号/浮点等族也通过类似模板批量启用。

## 4. 自定义类型实现 ToString

示例：为结构体实现 `ToString()`，即可方便打印：
```prajna
struct Point { x: i64; y: i64; }

implement Serializable for Point {
    func ToString()->String {
        var s = "(";
        s = s + this.x.ToString() + "," + this.y.ToString() + ")";
        return s;
    }
}

func Main(){
    var p: Point; p.x = 3i64; p.y = 4i64;
    p.PrintLine(); // (3,4)
}
```

## 5. 二进制序列化（入门说明）

`serialize` 模块提供了将值转换为二进制字节序列的能力（接口与实现可能随版本演进而更新）。常见形式：
```prajna
var bytes = serialize::ToBytes(x);
var y = serialize::FromBytes<MyType>(bytes);
```
注意：
- 需要确保类型的布局与序列化协议一致
- 不同平台/版本间的兼容性取决于你的协议设计；跨平台请优先使用自描述/文本协议或自行定义稳定格式

## 6. 测试：@test 与断言

写一个最小化测试用例：
```prajna
@test
func MyCase(){
    var a = 2i64 + 2i64;
    test::Assert(a == 4i64);
}
```

断言工具（节选）：
- `test::Assert(condition: bool)`：失败时退出
- `test::AssertWithMessage(cond, msg)`：带消息
- `test::AssertWithPosition(cond, file, line)`：带源位置信息

## 7. 常见坑与修复

- `ToString()` 未实现导致无法打印
  - 修复：为自定义类型实现 `Serializable`；或转为已支持的类型打印
- 浮点打印不符合预期（如非常小的数）
  - 修复：系统会在固定小数与科学计数法间选择；需要特定格式可自行实现 `ToString()`
- 序列化跨版本/跨平台不兼容
  - 修复：定义稳定协议或使用文本/JSON/YAML 等格式
- 测试中断言未生效
  - 修复：确认调用了断言函数；失败后会 `exit(-1)` 终止

## 8. 练习

1) 为 `struct Rect{ w:i64; h:i64; }` 实现 `ToString()`，输出 `Rect(w,h)`，并打印。
2) 写一个测试：断言 `Rect{2,3}` 的字符串为 `Rect(2,3)`。
3) 试着为 `Array<i64, 4>` 生成字节序列并反序列化，验证一致性（思考跨平台大小端等问题）。
