// Test actual socket creation and operations without external library linking
use net;

@test
func TestRealSocketCreation() {
    ("=== Testing Real Socket Creation ===").PrintLine();
    
    // Create a real TCP socket
    var domain = net::GetAfInet();
    var sock_type = net::GetSockStream(); 
    var protocol = net::GetTcpProtocol();
    
    ("Creating socket with AF_INET=" + domain.ToString() + 
     ", SOCK_STREAM=" + sock_type.ToString() + 
     ", IPPROTO_TCP=" + protocol.Value().ToString()).PrintLine();
    
    // Call the actual socket() system call
    var sockfd = net::CreateSocket(domain, sock_type, protocol.Value());
    
    ("Socket file descriptor: " + sockfd.ToString()).PrintLine();
    
    // Verify socket creation was successful
    test::Assert(sockfd >= 0i32);
    
    if (sockfd >= 0i32) {
        ("Socket created successfully!").PrintLine();
        
        // Close the socket
        var close_result = net::CloseSocket(sockfd);
        ("Close result: " + close_result.ToString()).PrintLine();
        test::Assert(close_result == 0i32);
        
        ("Socket closed successfully!").PrintLine();
    }
}

@test
func TestNetworkByteOrderConversion() {
    ("=== Testing Network Byte Order Conversion ===").PrintLine();
    
    // Test port conversion
    var host_port = 8080u16;
    var network_port = net::HostToNetworkShort(host_port);
    var back_to_host_port = net::NetworkToHostShort(network_port);
    
    ("Host port: " + host_port.ToString()).PrintLine();
    ("Network port: " + network_port.ToString()).PrintLine();
    ("Back to host: " + back_to_host_port.ToString()).PrintLine();
    
    test::Assert(back_to_host_port == host_port);
    
    // Test address conversion (127.0.0.1)
    var host_addr: u32 = 2130706433u32; // 127.0.0.1 in host byte order (0x7f000001)
    var network_addr = net::HostToNetworkLong(host_addr);
    var back_to_host_addr = net::NetworkToHostLong(network_addr);
    
    ("Host addr: 0x" + host_addr.ToString()).PrintLine();
    ("Network addr: 0x" + network_addr.ToString()).PrintLine();
    ("Back to host: 0x" + back_to_host_addr.ToString()).PrintLine();
    
    test::Assert(back_to_host_addr == host_addr);
    
    ("Byte order conversion tests passed!").PrintLine();
}

@test
func TestMultipleSocketOperations() {
    ("=== Testing Multiple Socket Operations ===").PrintLine();
    
    // Test creating multiple sockets
    var sockfd1 = net::CreateSocket(net::GetAfInet(), net::GetSockStream(), 6i32);
    var sockfd2 = net::CreateSocket(net::GetAfInet(), net::GetSockStream(), 6i32);
    
    ("Socket 1 fd: " + sockfd1.ToString()).PrintLine();
    ("Socket 2 fd: " + sockfd2.ToString()).PrintLine();
    
    test::Assert(sockfd1 >= 0i32);
    test::Assert(sockfd2 >= 0i32);
    test::Assert(sockfd1 != sockfd2); // Should be different file descriptors
    
    if (sockfd1 >= 0i32) {
        var close_result1 = net::CloseSocket(sockfd1);
        ("Close socket 1 result: " + close_result1.ToString()).PrintLine();
        test::Assert(close_result1 == 0i32);
    }
    
    if (sockfd2 >= 0i32) {
        var close_result2 = net::CloseSocket(sockfd2);
        ("Close socket 2 result: " + close_result2.ToString()).PrintLine();
        test::Assert(close_result2 == 0i32);
    }
    
    ("Multiple socket operations completed successfully!").PrintLine();
}
