@test
func TestDefaultConstruction() {
    var p: Ptr<i64>;
    test::Assert(p.IsNull());
    test::Assert(p.ToInt64() == 0i64);
    test::Assert(p.ReferenceCount() == 1);
}

@test
func TestNullStaticMethod() {
    var p = Ptr<i64>::Null();
    test::Assert(p.IsNull());
    test::Assert(p.ToInt64() == 0i64);
}

@test
func TestNewAllocation() {
    var p = Ptr<i64>::New();
    test::Assert(!p.IsNull());
    test::Assert(p.ToInt64() != 0i64);
    test::Assert(p.ReferenceCount() == 1);

    p[0] = 42;
    test::Assert(p[0] == 42);
}

@test
func TestAllocateMultiple() {
    var p = Ptr<i64>::Allocate(10);
    test::Assert(!p.IsNull());
    test::Assert(p.ReferenceCount() == 1);

    for i in 0 to 10 {
        p[i] = i;
    }
    for i in 0 to 10 {
        test::Assert(p[i] == i);
    }
}

@test
func TestCopyIncrementsRefCount() {
    var p1 = Ptr<i64>::New();
    test::Assert(p1.ReferenceCount() == 1);

    var p2 = p1;
    test::Assert(p1.ReferenceCount() == 2);
    test::Assert(p2.ReferenceCount() == 2);
}

@test
func TestAssignmentRefCount() {
    var p1 = Ptr<i64>::New();
    var p2 = Ptr<i64>::New();

    test::Assert(p1.ReferenceCount() == 1);
    test::Assert(p2.ReferenceCount() == 1);

    p2 = p1;
    test::Assert(p1.ReferenceCount() == 2);
    test::Assert(p2.ReferenceCount() == 2);
}

@test
func TestScopeRefCount() {
    var p: Ptr<i64>;
    {
        var p1 = Ptr<i64>::New();
        test::Assert(p1.ReferenceCount() == 1);
        p = p1;
        test::Assert(p1.ReferenceCount() == 2);
        test::Assert(p.ReferenceCount() == 2);
    }
    test::Assert(p.ReferenceCount() == 1);
    test::Assert(!p.IsNull());
}

struct TestObject {
    value: i64;
    initialized: bool;
    finalized: bool;
}

implement TestObject {
    func __initialize__() {
        this.value = 0;
        this.initialized = true;
        this.finalized = false;
        "TestObject::initialize".PrintLine();
    }

    func __copy__() {
        "TestObject::copy".PrintLine();
    }

    func __finalize__() {
        this.finalized = true;
        "TestObject::finalize".PrintLine();
    }
}

@test
func TestObjectLifecycle() {
    var p = Ptr<TestObject>::New();
    test::Assert(p->initialized);
    test::Assert(!p->finalized);
    p->value = 42;
    test::Assert(p->value == 42);
}

@test
func TestNestedPtr() {
    var p = Ptr<Ptr<i64>>::New();
    test::Assert(!p.IsNull());
    test::Assert(p[0].IsNull());

    p[0] = Ptr<i64>::New();
    test::Assert(!p[0].IsNull());
    p[0][0] = 123;
    test::Assert(p[0][0] == 123);
}

@test
func TestNullOperations() {
    var p = Ptr<i64>::Null();
    test::Assert(p.IsNull());
    test::Assert(p.ReferenceCount() == 1);

    var p2 = p;
    test::Assert(p2.IsNull());
}

template <Type>
struct Node{
    object: Type;
    next_shared: Ptr<Node<Type>>;
}

@test
func TestCircularReference() {
   var node0_ptr = Ptr<Node<i64>>::New();
   node0_ptr->object = 1024;

   var node1_ptr = Ptr<Node<i64>>::New();
   node1_ptr->object = 4201;

   test::Assert(node0_ptr.ReferenceCount() == 1);
   test::Assert(node1_ptr.ReferenceCount() == 1);

   node0_ptr->next_shared = node1_ptr;
   node1_ptr->next_shared = node0_ptr;

   test::Assert(node0_ptr.ReferenceCount() == 2);
   test::Assert(node1_ptr.ReferenceCount() == 2);

   node1_ptr->next_shared = Ptr<Node<i64>>::Null();

   test::Assert(node0_ptr.ReferenceCount() == 1);
   test::Assert(node1_ptr.ReferenceCount() == 2);

   node0_ptr->next_shared = Ptr<Node<i64>>::Null();

   test::Assert(node0_ptr.ReferenceCount() == 1);
   test::Assert(node1_ptr.ReferenceCount() == 1);
}

struct TestItem {
    value: i64;
}

implement TestItem {
    func __initialize__() {
        this.value = 0;
        "TestItem::initialize".PrintLine();
    }

    func __copy__() {
        "TestItem::copy".PrintLine();
    }

    func __finalize__() {
        "TestItem::finalize".PrintLine();
    }
}

struct CompositeObject {
    item: TestItem;
    id: i64;
}

implement CompositeObject {
    func __initialize__() {
        this.id = -1;
        "CompositeObject::initialize".PrintLine();
    }

    func __copy__() {
        "CompositeObject::copy".PrintLine();
    }

    func __finalize__() {
        "CompositeObject::finalize".PrintLine();
    }
}

@test
func TestCompositeObjectAllocation() {
    var composite_ptr = Ptr<CompositeObject>::New();

    test::Assert(!composite_ptr.IsNull());
    test::Assert(composite_ptr.ReferenceCount() == 1);

    composite_ptr->id = 100;
    composite_ptr->item.value = 42;

    test::Assert(composite_ptr->id == 100);
    test::Assert(composite_ptr->item.value == 42);
}